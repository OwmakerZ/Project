# Poseidon2 哈希算法 Circom 电路数学原理说明

## 1. 算法概述

Poseidon2 是一种面向零知识证明系统优化的哈希函数，主要特点如下：

- 基于 Sponge 架构（海绵结构）；
- 设计参数：状态长度 `t`，轮数 `r_f` / `r_p`，S-box 非线性度 `d`；
- 高度优化，适用于 SNARK 电路计算，减少乘法门数量。

公式描述：

1. 状态向量：

\[
\mathbf{S} = (s_0, s_1, \dots, s_{t-1})
\]

2. 初始填充：

\[
\mathbf{S}^{(0)} = (\text{0}, x_1, x_2, \dots)
\]

其中 \(x_i\) 为明文输入块（单 block 场景）。

3. 轮函数（Round Function）：

每轮更新状态向量：

\[
\mathbf{S}^{(r+1)} = MDS \cdot \mathbf{S}^{(r)} + \mathbf{RC}^{(r)}
\]

然后对部分或全部分量应用非线性 S-box：

\[
s_i^{(r+1)} \gets (s_i^{(r+1)})^d
\]

- \(MDS\) 为最大距离可分矩阵（线性混合层）；
- \(\mathbf{RC}^{(r)}\) 为轮常量；
- \(d\) 为幂次，用于 S-box 非线性映射。

## 2. Sponge 架构与单 block 输入

- 海绵函数包括吸收（absorb）与挤压（squeeze）阶段；
- 单 block 输入时，整个输入直接填充到状态向量的部分位置，其余填零；
- 输出取状态向量的部分分量作为最终哈希值。

## 3. Circom 电路建模原则

- 每一个状态元素对应一个电路信号；
- S-box 非线性映射通过乘法链实现 \((x^d)\)；
- MDS 矩阵乘法展开为加法与乘法门；
- 轮常量直接加到状态信号上；
- 输入为隐私信号，输出为公开信号。

## 4. Groth16 证明原理

- 电路描述 Poseidon2 哈希运算过程；
- Prover 提供隐私输入 \(x\)；
- 生成 SNARK 证明，证明电路运算正确且输出为预期哈希值 \(H(x)\)；
- Verifier 仅需要验证电路输出与公开哈希值一致，无需知道隐私输入。

## 5. 参数选择参考

- 根据文献 Table1，可选参数：
    - \((n,t,d) = (256,3,5)\)
    - \((n,t,d) = (256,2,5)\)
- 其中 `t` 为状态长度，`d` 为 S-box 幂次。
